"""
Schema Migration Tests

Auto-generated by GoalGen
Tests schema version migrations
"""

import pytest
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

{% if schema_migrations %}
from langgraph.schema_migrations import (
    migrate_state,
    CURRENT_SCHEMA_VERSION,
    get_migration_path,
    validate_migration_chain,
    MIGRATIONS
)


def test_current_schema_version():
    """Test that CURRENT_SCHEMA_VERSION matches spec"""
    assert CURRENT_SCHEMA_VERSION == {{ schema_version | default(1) }}


def test_migration_chain_complete():
    """Test that all migrations from v1 to current exist"""
    assert validate_migration_chain() is True


def test_migration_path():
    """Test migration path calculation"""
    {% if schema_version and schema_version > 1 %}
    path = get_migration_path(1, CURRENT_SCHEMA_VERSION)
    assert len(path) == CURRENT_SCHEMA_VERSION - 1
    assert path[0] == "1_to_2"
    {% if schema_version > 2 %}
    assert path[-1] == "{{ schema_version - 1 }}_to_{{ schema_version }}"
    {% endif %}
    {% else %}
    # No migrations for v1
    path = get_migration_path(1, 1)
    assert len(path) == 0
    {% endif %}


def test_no_migration_needed_for_current_version():
    """Test that current version state is returned unchanged"""
    state = {
        "schema_version": CURRENT_SCHEMA_VERSION,
        "messages": [],
        "next": None,
        "completed_tasks": []
    }

    result = migrate_state(state)
    assert result["schema_version"] == CURRENT_SCHEMA_VERSION


{% for migration_key, migration_spec in schema_migrations.items() %}
def test_migration_{{ migration_key }}():
    """
    Test migration {{ migration_key }}
    {{ migration_spec.get('description', 'No description') }}
    """

    {% set from_version, to_version = migration_key.split('_to_') %}
    # Create state at version {{ from_version }}
    old_state = {
        "schema_version": {{ from_version }},
        "messages": [],
        "next": None,
        "completed_tasks": [],
    }

    {% set migration_type = migration_spec.get('migration', 'set_default') %}
    {% if migration_type == 'set_default' %}
    # State should not have new fields yet
    {% for field_name in migration_spec.get('added_fields', []) %}
    assert "{{ field_name }}" not in old_state
    {% endfor %}

    # Migrate
    migrated = MIGRATIONS["{{ migration_key }}"](old_state.copy())

    # Assert new fields added with default values
    {% for field_name in migration_spec.get('added_fields', []) %}
    assert "{{ field_name }}" in migrated
    {% set default_value = migration_spec.get('default_values', {}).get(field_name) %}
    {% if default_value is not none %}
    assert migrated["{{ field_name }}"] == {{ default_value | tojson }}
    {% endif %}
    {% endfor %}

    {% elif migration_type == 'rename_field' %}
    # Add old field names to state
    {% for old_name, new_name in migration_spec.get('renamed_fields', {}).items() %}
    old_state["{{ old_name }}"] = "test_value_{{ loop.index }}"
    {% endfor %}

    # Migrate
    migrated = MIGRATIONS["{{ migration_key }}"](old_state.copy())

    # Assert fields renamed
    {% for old_name, new_name in migration_spec.get('renamed_fields', {}).items() %}
    assert "{{ old_name }}" not in migrated
    assert "{{ new_name }}" in migrated
    assert migrated["{{ new_name }}"] == "test_value_{{ loop.index }}"
    {% endfor %}

    {% elif migration_type == 'remove_field' %}
    # Add deprecated fields to state
    {% for field_name in migration_spec.get('removed_fields', []) %}
    old_state["{{ field_name }}"] = "deprecated_value"
    {% endfor %}

    # Migrate
    migrated = MIGRATIONS["{{ migration_key }}"](old_state.copy())

    # Assert fields removed
    {% for field_name in migration_spec.get('removed_fields', []) %}
    assert "{{ field_name }}" not in migrated
    {% endfor %}

    {% elif migration_type == 'transform' %}
    # Add fields with old type
    {% for field_name, transform_spec in migration_spec.get('transformed_fields', {}).items() %}
    # TODO: Set up test data for {{ field_name }} transformation
    # From: {{ transform_spec.get('from_type', 'unknown') }}
    # To: {{ transform_spec.get('to_type', 'unknown') }}
    pass
    {% endfor %}

    # Migrate
    migrated = MIGRATIONS["{{ migration_key }}"](old_state.copy())

    # TODO: Assert transformation occurred correctly
    {% endif %}


{% endfor %}

{% if schema_version and schema_version > 1 %}
def test_full_migration_chain():
    """Test migrating from v1 all the way to current version"""

    # Start with v1 state
    v1_state = {
        "schema_version": 1,
        "messages": [],
        "next": None,
        "completed_tasks": [],
    }

    # Migrate to current
    migrated = migrate_state(v1_state)

    # Assert at current version
    assert migrated["schema_version"] == CURRENT_SCHEMA_VERSION

    # Assert all expected fields exist
    assert "messages" in migrated
    assert "next" in migrated
    assert "completed_tasks" in migrated


def test_partial_migration_chain():
    """Test migrating from intermediate version to current"""

    {% if schema_version > 2 %}
    # Start with intermediate version
    intermediate_state = {
        "schema_version": {{ schema_version - 1 }},
        "messages": [],
        "next": None,
        "completed_tasks": [],
    }

    # Migrate to current
    migrated = migrate_state(intermediate_state)

    # Assert at current version
    assert migrated["schema_version"] == CURRENT_SCHEMA_VERSION
    {% else %}
    # Only one migration exists, skip partial chain test
    pass
    {% endif %}
{% endif %}


def test_migration_preserves_existing_data():
    """Test that migrations don't lose existing data"""

    state = {
        "schema_version": 1,
        "messages": [{"role": "user", "content": "test"}],
        "next": "supervisor",
        "completed_tasks": ["task1"],
        "thread_id": "thread_123",
        "user_id": "user_456",
    }

    migrated = migrate_state(state)

    # Assert existing data preserved
    assert migrated["messages"] == state["messages"]
    assert migrated["next"] == state["next"]
    assert migrated["completed_tasks"] == state["completed_tasks"]
    assert migrated["thread_id"] == state["thread_id"]
    assert migrated["user_id"] == state["user_id"]


{% else %}
# No schema migrations defined - this is version 1

def test_no_migrations():
    """Test that no migrations exist for v1 schema"""
    assert CURRENT_SCHEMA_VERSION == 1
    assert len(MIGRATIONS) == 0


def test_migrate_state_returns_unchanged():
    """Test that migrate_state returns state unchanged for v1"""
    state = {
        "schema_version": 1,
        "messages": [],
        "next": None,
        "completed_tasks": []
    }

    result = migrate_state(state)
    assert result == state
{% endif %}
