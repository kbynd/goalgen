"""
Bot Framework Server for {{ goal_title }} Teams Bot

This server wraps the bot handler and exposes it via HTTP
for the Bot Framework Emulator to connect to.

Usage:
    python server.py

This is for LOCAL DEVELOPMENT ONLY.
For production, deploy to Azure Bot Service.
"""

import os
import sys
from aiohttp import web
from aiohttp.web import Request, Response
from botbuilder.core import BotFrameworkAdapter, BotFrameworkAdapterSettings
from botbuilder.schema import Activity

# Add parent directory to path to import bot
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from bot import {{ goal_id.replace('_', ' ').title().replace(' ', '') }}Bot
from config import Config

# Load configuration
config = Config.from_env()

# Create adapter
settings = BotFrameworkAdapterSettings(
    app_id=config.microsoft_app_id,
    app_password=config.microsoft_app_password
)
adapter = BotFrameworkAdapter(settings)

# Create bot
bot = {{ goal_id.replace('_', ' ').title().replace(' ', '') }}Bot(config)


# Error handler
async def on_error(context, error):
    print(f"\\n[ERROR] {error}", file=sys.stderr)
    await context.send_activity("Sorry, something went wrong.")


adapter.on_turn_error = on_error


# Bot endpoint
async def messages(req: Request) -> Response:
    """Handle incoming messages from Bot Framework"""
    if req.content_type == "application/json":
        body = await req.json()
    else:
        return Response(status=415, text="Unsupported Media Type")

    activity = Activity().deserialize(body)
    auth_header = req.headers.get("Authorization", "")

    try:
        response = await adapter.process_activity(activity, auth_header, bot.on_turn)
        if response:
            return web.json_response(data=response.body, status=response.status)
        return Response(status=201)
    except Exception as e:
        print(f"\\n[ERROR] Processing activity: {e}", file=sys.stderr)
        return Response(status=500, text=str(e))


# Health check endpoint
async def health(req: Request) -> Response:
    """Health check endpoint"""
    return web.json_response({"status": "healthy", "bot": "{{ goal_title }}"})


# Create app
app = web.Application()
app.router.add_post("/api/messages", messages)
app.router.add_get("/health", health)

if __name__ == "__main__":
    print("=" * 60)
    print("Bot Framework Server - {{ goal_title }}")
    print("=" * 60)
    print(f"Bot: {{ goal_id.replace('_', ' ').title().replace(' ', '') }}Bot")
    print(f"App ID: {config.microsoft_app_id or '(none - emulator mode)'}")
    print(f"LangGraph API: {config.langgraph_api_url}")
    print(f"API Timeout: {config.langgraph_api_timeout}s")
    print(f"Conversation Strategy: {config.conversation_mapping_config.get('strategy', 'hash')}")
    print("=" * 60)
    print("\\nEndpoints:")
    print("  POST http://localhost:3978/api/messages  - Bot messages")
    print("  GET  http://localhost:3978/health        - Health check")
    print("\\nBot Framework Emulator Configuration:")
    print("  Bot URL: http://localhost:3978/api/messages")
    print("  App ID: (leave empty for local testing)")
    print("  App Password: (leave empty for local testing)")
    print("=" * 60)
    print("\\nStarting server on http://localhost:3978")
    print("Press Ctrl+C to stop\\n")

    web.run_app(app, host="localhost", port=3978)
