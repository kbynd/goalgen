"""
Azure Function for {{ tool_name }}

Auto-generated by GoalGen
"""

import azure.functions as func
import logging
import json
import os

{% if tool.type == 'http' %}
import aiohttp
{% endif %}

app = func.FunctionApp()
logger = logging.getLogger(__name__)


@app.route(route="{{ tool_name }}", methods=["POST"], auth_level=func.AuthLevel.FUNCTION)
async def {{ tool_name }}_handler(req: func.HttpRequest) -> func.HttpResponse:
    """{{ tool.get('description', 'Execute ' + tool_name) }}"""

    logger.info(f"{{ tool_name }} invoked")

    try:
        req_body = req.get_json()

        {% if tool.type == 'http' %}
        result = await call_external_api(req_body)
        {% else %}
        result = {"success": True, "tool": "{{ tool_name }}", "params": req_body}
        {% endif %}

        return func.HttpResponse(
            json.dumps(result),
            status_code=200,
            mimetype="application/json"
        )

    except Exception as e:
        logger.error(f"Error: {e}")
        return func.HttpResponse(
            json.dumps({"error": str(e)}),
            status_code=500,
            mimetype="application/json"
        )


{% if tool.type == 'http' %}
async def call_external_api(params):
    """Call external HTTP API"""

    url = "{{ tool.spec.url }}"
    headers = {}

    # Add API key if configured
    api_key = os.getenv("{{ tool_name | upper }}_API_KEY")
    if api_key:
        headers["Authorization"] = f"Bearer {api_key}"

    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=params, headers=headers) as response:
            response.raise_for_status()
            return await response.json()
{% endif %}
