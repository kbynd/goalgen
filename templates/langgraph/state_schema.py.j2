"""
State Schema for {{ goal_id }}

Auto-generated by GoalGen
Defines the state structure for LangGraph workflow

Schema Version: {{ schema_version | default(1) }}
{% if schema_migrations %}
Migrations Defined:
{% for migration_key in schema_migrations.keys() %}
  - {{ migration_key }}: {{ schema_migrations[migration_key].get('description', 'No description') }}
{% endfor %}
{% endif %}
"""

from typing import TypedDict, List, Dict, Any, Optional, Annotated
from langchain_core.messages import BaseMessage
from langgraph.graph.message import add_messages

# Current schema version
SCHEMA_VERSION = {{ schema_version | default(1) }}


class {{ goal_id | pascal_case }}State(TypedDict):
    """
    State schema for {{ goal_id }} workflow

    Fields:
    - messages: Conversation history (auto-reduced by LangGraph)
    {% if context_fields %}
    - Context fields (strongly typed):
    {% for field_name, field_spec in context_fields.items() %}
      - {{ field_name }}: {{ field_spec.get('description', field_name | replace('_', ' ') | title) }}
    {% endfor %}
    {% else %}
    - context: Generic context dictionary
    {% endif %}
    - next: Next node to execute (for routing)
    - completed_tasks: List of completed task IDs
    """

    # Schema version tracking
    schema_version: int  # Current: {{ schema_version | default(1) }}

    # Messages (with automatic message reduction)
    messages: Annotated[List[BaseMessage], add_messages]

    {% if context_fields %}
    # Strongly-typed context fields from spec
    {% for field_name, field_spec in context_fields.items() %}
    {{ field_name }}: Optional[{{ field_spec.get('type', 'str') }}]  # {{ field_spec.get('description', '') }}
    {% endfor %}
    {% else %}
    # Generic context (no context_fields defined in spec)
    context: Dict[str, Any]
    {% endif %}

    # Routing
    next: Optional[str]

    # Task tracking
    completed_tasks: List[str]

    # Metadata
    thread_id: Optional[str]
    user_id: Optional[str]
    conversation_insights: Optional[Dict[str, Any]]
