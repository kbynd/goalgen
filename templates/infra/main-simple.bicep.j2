// Main Bicep Template for {{ goal_id }}
// Simplified Container Apps deployment with ACR
// Generated by GoalGen

targetScope = 'resourceGroup'

// ============================================================================
// PARAMETERS
// ============================================================================

@description('Application name (used as prefix for all resources)')
param appName string = '{{ goal_id }}'

@description('Azure region for resources')
param location string = resourceGroup().location

@description('Environment name (dev, staging, prod)')
@allowed([
  'dev'
  'staging'
  'prod'
])
param environment string = 'dev'

@description('Container image tag')
param imageTag string = 'v1'

@description('OpenAI API Key')
@secure()
param openAiApiKey string

@description('OpenAI Model Name')
param openAiModelName string = 'gpt-4o-mini'

@description('Use memory checkpointer (true for in-memory, false for persistent)')
param useMemoryCheckpointer bool = true

@description('Log level (DEBUG, INFO, WARNING, ERROR)')
@allowed([
  'DEBUG'
  'INFO'
  'WARNING'
  'ERROR'
])
param logLevel string = 'INFO'

@description('Container CPU allocation')
param containerCpu string = '1.0'

@description('Container memory allocation')
param containerMemory string = '2.0Gi'

@description('Minimum replicas for auto-scaling')
param minReplicas int = 1

@description('Maximum replicas for auto-scaling')
param maxReplicas int = 3

@description('ACR SKU (Basic, Standard, Premium)')
@allowed([
  'Basic'
  'Standard'
  'Premium'
])
param acrSku string = 'Basic'

// ============================================================================
// VARIABLES
// ============================================================================

var uniqueSuffix = substring(uniqueString(resourceGroup().id), 0, 4)
var acrName = '${appName}acr${uniqueSuffix}'
var envName = '${appName}-env-${environment}'
var containerAppName = '${appName}-app-${environment}'
var logAnalyticsName = '${appName}-logs-${environment}'
var containerImage = '${acrName}.azurecr.io/${appName}:${imageTag}'

var tags = {
  application: appName
  environment: environment
  managedBy: 'bicep'
  createdDate: utcNow('yyyy-MM-dd')
}

// ============================================================================
// MODULES
// ============================================================================

// Azure Container Registry
module acr 'modules/acr.bicep' = {
  name: 'acr-deployment'
  params: {
    acrName: acrName
    location: location
    acrSku: acrSku
    adminUserEnabled: true
    tags: tags
  }
}

// Container Apps Environment with Log Analytics
module containerAppsEnv 'modules/container-apps-environment.bicep' = {
  name: 'containerenv-deployment'
  params: {
    envName: envName
    location: location
    logAnalyticsName: logAnalyticsName
    tags: tags
  }
}

// Get ACR credentials (requires admin user enabled)
resource acrResource 'Microsoft.ContainerRegistry/registries@2023-01-01-preview' existing = {
  name: acrName
}

// Container App
module containerApp 'modules/container-app.bicep' = {
  name: 'containerapp-deployment'
  params: {
    appName: containerAppName
    location: location
    environmentId: containerAppsEnv.outputs.environmentId
    containerImage: containerImage
    registryServer: acr.outputs.loginServer
    registryUsername: acrName
    registryPassword: acrResource.listCredentials().passwords[0].value
    targetPort: 8000
    externalIngress: true
    cpu: containerCpu
    memory: containerMemory
    minReplicas: minReplicas
    maxReplicas: maxReplicas
    environmentVariables: [
      {
        name: 'OPENAI_API_KEY'
        value: openAiApiKey
      }
      {
        name: 'OPENAI_MODEL_NAME'
        value: openAiModelName
      }
      {
        name: 'USE_MEMORY_CHECKPOINTER'
        value: string(useMemoryCheckpointer)
      }
      {
        name: 'LOG_LEVEL'
        value: logLevel
      }
      {
        name: 'ENV'
        value: environment
      }
    ]
    tags: tags
  }
  dependsOn: [
    acr
  ]
}

// ============================================================================
// OUTPUTS
// ============================================================================

@description('Application URL')
output appUrl string = 'https://${containerApp.outputs.fqdn}'

@description('ACR Login Server')
output acrLoginServer string = acr.outputs.loginServer

@description('ACR Name')
output acrName string = acr.outputs.acrName

@description('Container Apps Environment Name')
output environmentName string = containerAppsEnv.outputs.environmentName

@description('Container App Name')
output containerAppName string = containerApp.outputs.appName

@description('Log Analytics Workspace ID')
output logAnalyticsId string = containerAppsEnv.outputs.logAnalyticsId

@description('Resource Group Location')
output location string = location

@description('Deployment Tags')
output tags object = tags
