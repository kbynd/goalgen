// Main Bicep template for {{ goal_id }}
// Auto-generated by GoalGen

targetScope = 'resourceGroup'

@description('Environment name (dev, staging, prod)')
param environmentName string = 'dev'

@description('Location for all resources')
param location string = resourceGroup().location

@description('Azure Tenant ID (defaults to current tenant)')
param tenantId string = subscription().tenantId

@description('Azure Subscription ID (defaults to current subscription)')
param subscriptionId string = subscription().subscriptionId

@description('Azure OpenAI endpoint')
param azureOpenAIEndpoint string

@description('Azure OpenAI API key')
@secure()
param azureOpenAIKey string

// Variables
var namePrefix = '{{ goal_id }}-${environmentName}'
var tags = {
  environment: environmentName
  goal: '{{ goal_id }}'
  managedBy: 'GoalGen'
}

// Key Vault for secrets
module keyVault 'modules/keyvault.bicep' = {
  name: 'keyVault'
  params: {
    name: '${namePrefix}-kv'
    location: location
    tags: tags
    tenantId: tenantId
  }
}

{% if checkpointing_backend == 'cosmos' %}
// Cosmos DB for checkpointing
module cosmosDb 'modules/cosmos.bicep' = {
  name: 'cosmosDb'
  params: {
    name: '${namePrefix}-cosmos'
    location: location
    tags: tags
    databaseName: '{{ goal_id }}_db'
    containerName: 'checkpoints'
  }
}
{% elif checkpointing_backend == 'redis' %}
// Redis Cache for checkpointing
module redisCache 'modules/redis.bicep' = {
  name: 'redisCache'
  params: {
    name: '${namePrefix}-redis'
    location: location
    tags: tags
  }
}
{% endif %}

// Container Apps Environment
module containerEnv 'modules/container-env.bicep' = {
  name: 'containerEnv'
  params: {
    name: '${namePrefix}-env'
    location: location
    tags: tags
  }
}

// API Container App
module apiApp 'modules/containerapp.bicep' = {
  name: 'apiApp'
  params: {
    name: '${namePrefix}-api'
    location: location
    tags: tags
    environmentId: containerEnv.outputs.environmentId
    containerImage: 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest'
    environmentVariables: [
      {
        name: 'AZURE_OPENAI_ENDPOINT'
        value: azureOpenAIEndpoint
      }
      {
        name: 'AZURE_OPENAI_API_KEY'
        secretRef: 'openai-key'
      }
      {% if checkpointing_backend == 'cosmos' %}
      {
        name: 'COSMOS_ENDPOINT'
        value: cosmosDb.outputs.endpoint
      }
      {
        name: 'COSMOS_KEY'
        secretRef: 'cosmos-key'
      }
      {% elif checkpointing_backend == 'redis' %}
      {
        name: 'REDIS_CONNECTION_STRING'
        secretRef: 'redis-connection'
      }
      {% endif %}
    ]
    secrets: [
      {
        name: 'openai-key'
        value: azureOpenAIKey
      }
      {% if checkpointing_backend == 'cosmos' %}
      {
        name: 'cosmos-key'
        value: cosmosDb.outputs.primaryKey
      }
      {% elif checkpointing_backend == 'redis' %}
      {
        name: 'redis-connection'
        value: redisCache.outputs.connectionString
      }
      {% endif %}
    ]
  }
}

{% if tools %}
// Function App for tools
module functionApp 'modules/functionapp.bicep' = {
  name: 'functionApp'
  params: {
    name: '${namePrefix}-func'
    location: location
    tags: tags
  }
}
{% endif %}

// Outputs
output apiUrl string = apiApp.outputs.fqdn
output keyVaultName string = keyVault.outputs.name
{% if checkpointing_backend == 'cosmos' %}
output cosmosEndpoint string = cosmosDb.outputs.endpoint
{% elif checkpointing_backend == 'redis' %}
output redisHostName string = redisCache.outputs.hostName
{% endif %}
