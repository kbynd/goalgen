#!/usr/bin/env python3
"""
Test Prompts Locally
Generated by GoalGen

Renders prompt templates with test context for local validation
"""

import sys
import json
from pathlib import Path
from string import Template


def load_prompt(prompt_file: Path) -> str:
    """Load prompt template from file"""
    if not prompt_file.exists():
        raise FileNotFoundError(f"Prompt not found: {prompt_file}")

    with open(prompt_file, 'r') as f:
        return f.read()


def render_prompt(template_content: str, context: dict) -> str:
    """Render prompt with context variables"""
    # Simple variable substitution (same as PromptLoader)
    template = Template(template_content)
    return template.safe_substitute(context)


def test_agent_prompt(agent_name: str, test_context: dict = None):
    """
    Test a single agent prompt

    Args:
        agent_name: Name of the agent (e.g., "supervisor_agent")
        test_context: Dictionary of test variables
    """

    prompts_dir = Path(__file__).parent.parent / "prompts"
    prompt_file = prompts_dir / f"{agent_name}.md"

    print(f"\n{'='*60}")
    print(f"Testing Prompt: {agent_name}")
    print(f"{'='*60}\n")

    # Load template
    try:
        template = load_prompt(prompt_file)
    except FileNotFoundError as e:
        print(f"‚ùå {e}")
        return

    # Default test context
    default_context = {
        "context": json.dumps({
            "destination": "Paris",
            "dates": "Dec 15-22",
            "budget": "$2000"
        }, indent=2),
        "history": "User: I want to plan a trip\nAssistant: I'd be happy to help!",
        "user_message": "Find me flights to Paris",
        "task_description": "Search for flight options"
    }

    # Merge with user-provided context
    final_context = {**default_context, **(test_context or {})}

    # Render
    rendered = render_prompt(template, final_context)

    # Display
    print("üìù Rendered Prompt:")
    print("-" * 60)
    print(rendered)
    print("-" * 60)
    print(f"\n‚úì Prompt renders successfully ({len(rendered)} chars)")
    print(f"\nContext used:")
    for key, value in final_context.items():
        preview = str(value)[:50] + "..." if len(str(value)) > 50 else str(value)
        print(f"  - {key}: {preview}")


def test_all_prompts():
    """Test all prompts in the prompts directory"""

    prompts_dir = Path(__file__).parent.parent / "prompts"

    if not prompts_dir.exists():
        print(f"‚ùå Prompts directory not found: {prompts_dir}")
        return

    prompt_files = list(prompts_dir.glob("*.md"))

    if not prompt_files:
        print("‚ùå No prompt files found")
        return

    print(f"\n{'='*60}")
    print(f"Testing All Prompts ({len(prompt_files)} found)")
    print(f"{'='*60}")

    for prompt_file in prompt_files:
        agent_name = prompt_file.stem
        test_agent_prompt(agent_name)
        print()


def interactive_mode():
    """Interactive REPL for testing prompts"""

    print("\n" + "="*60)
    print("üß™ Interactive Prompt Tester")
    print("="*60)
    print("\nCommands:")
    print("  test <agent_name>  - Test a specific agent prompt")
    print("  list               - List all available prompts")
    print("  all                - Test all prompts")
    print("  set <key> <value>  - Set context variable")
    print("  show context       - Show current context")
    print("  quit               - Exit")
    print()

    context = {}
    prompts_dir = Path(__file__).parent.parent / "prompts"

    while True:
        try:
            cmd = input("prompt> ").strip()

            if not cmd:
                continue

            parts = cmd.split(maxsplit=1)
            command = parts[0].lower()

            if command == "quit" or command == "exit":
                print("Goodbye!")
                break

            elif command == "list":
                prompt_files = list(prompts_dir.glob("*.md"))
                print(f"\nAvailable prompts ({len(prompt_files)}):")
                for pf in prompt_files:
                    print(f"  - {pf.stem}")

            elif command == "all":
                test_all_prompts()

            elif command == "test":
                if len(parts) < 2:
                    print("‚ùå Usage: test <agent_name>")
                else:
                    test_agent_prompt(parts[1], context)

            elif command == "set":
                if len(parts) < 2:
                    print("‚ùå Usage: set <key> <value>")
                else:
                    kv = parts[1].split(maxsplit=1)
                    if len(kv) < 2:
                        print("‚ùå Usage: set <key> <value>")
                    else:
                        context[kv[0]] = kv[1]
                        print(f"‚úì Set {kv[0]} = {kv[1]}")

            elif command == "show" and len(parts) > 1 and parts[1] == "context":
                print("\nCurrent context:")
                if context:
                    for k, v in context.items():
                        print(f"  {k} = {v}")
                else:
                    print("  (empty)")

            else:
                print(f"‚ùå Unknown command: {command}")

        except KeyboardInterrupt:
            print("\nInterrupted. Type 'quit' to exit.")
        except Exception as e:
            print(f"‚ùå Error: {e}")


def main():
    """Main entry point"""

    if len(sys.argv) < 2:
        print("Usage:")
        print("  python test_prompts.py <agent_name>      - Test specific agent")
        print("  python test_prompts.py all               - Test all prompts")
        print("  python test_prompts.py interactive       - Interactive mode")
        print("\nExample:")
        print("  python test_prompts.py supervisor_agent")
        print("  python test_prompts.py flight_agent")
        return

    command = sys.argv[1]

    if command == "all":
        test_all_prompts()
    elif command == "interactive" or command == "repl":
        interactive_mode()
    else:
        # Test specific agent
        test_agent_prompt(command)


if __name__ == "__main__":
    main()
