#!/bin/bash
set -e

# Deployment script for {{ goal_id }}
# Deploys infrastructure and application to Azure

echo "=== Deploying {{ goal_id }} to Azure ==="

# Required environment variables
RESOURCE_GROUP=${AZURE_RESOURCE_GROUP:-"{{ goal_id }}-rg"}
LOCATION=${AZURE_LOCATION:-"eastus"}
ENVIRONMENT=${ENVIRONMENT:-"dev"}
REGISTRY=${AZURE_CONTAINER_REGISTRY:-""}
IMAGE_TAG=${IMAGE_TAG:-"latest"}

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Validate required variables
if [ -z "$AZURE_OPENAI_ENDPOINT" ]; then
    echo -e "${YELLOW}Warning: AZURE_OPENAI_ENDPOINT not set${NC}"
fi

if [ -z "$AZURE_OPENAI_KEY" ]; then
    echo -e "${YELLOW}Warning: AZURE_OPENAI_KEY not set${NC}"
fi

echo -e "${BLUE}Environment:${NC}"
echo "  Resource Group: $RESOURCE_GROUP"
echo "  Location: $LOCATION"
echo "  Environment: $ENVIRONMENT"
echo "  Registry: ${REGISTRY:-"not set"}"

# Step 1: Create resource group
echo -e "${BLUE}Step 1: Creating resource group${NC}"
az group create \
    --name $RESOURCE_GROUP \
    --location $LOCATION \
    --tags environment=$ENVIRONMENT goal={{ goal_id }}

# Step 2: Deploy infrastructure with Bicep
echo -e "${BLUE}Step 2: Deploying infrastructure${NC}"

DEPLOYMENT_NAME="{{ goal_id }}-${ENVIRONMENT}-$(date +%Y%m%d-%H%M%S)"

az deployment group create \
    --resource-group $RESOURCE_GROUP \
    --name $DEPLOYMENT_NAME \
    --template-file infra/main.bicep \
    --parameters \
        environmentName=$ENVIRONMENT \
        location=$LOCATION \
        azureOpenAIEndpoint="${AZURE_OPENAI_ENDPOINT}" \
        azureOpenAIKey="${AZURE_OPENAI_KEY}"

# Get outputs from deployment
echo -e "${BLUE}Step 3: Retrieving deployment outputs${NC}"
API_URL=$(az deployment group show \
    --resource-group $RESOURCE_GROUP \
    --name $DEPLOYMENT_NAME \
    --query properties.outputs.apiUrl.value \
    -o tsv)

KEY_VAULT_NAME=$(az deployment group show \
    --resource-group $RESOURCE_GROUP \
    --name $DEPLOYMENT_NAME \
    --query properties.outputs.keyVaultName.value \
    -o tsv)

echo -e "${GREEN}✓ Infrastructure deployed${NC}"
echo "  API URL: $API_URL"
echo "  Key Vault: $KEY_VAULT_NAME"

# Step 4: Update Container App with actual image
if [ -n "$REGISTRY" ]; then
    echo -e "${BLUE}Step 4: Updating Container App image${NC}"
    
    CONTAINER_APP_NAME="{{ goal_id }}-${ENVIRONMENT}-api"
    
    az containerapp update \
        --resource-group $RESOURCE_GROUP \
        --name $CONTAINER_APP_NAME \
        --image ${REGISTRY}/{{ goal_id }}-api:${IMAGE_TAG}
    
    echo -e "${GREEN}✓ Container App updated with image: ${REGISTRY}/{{ goal_id }}-api:${IMAGE_TAG}${NC}"
fi

{% if tools %}
# Step 5: Deploy Azure Functions
echo -e "${BLUE}Step 5: Deploying Azure Functions${NC}"

FUNCTION_APP_NAME="{{ goal_id }}-${ENVIRONMENT}-func"

{% for tool_name in tools.keys() %}
echo "  Deploying {{ tool_name }}..."
az functionapp deployment source config-zip \
    --resource-group $RESOURCE_GROUP \
    --name $FUNCTION_APP_NAME \
    --src {{ tool_name }}.zip

echo -e "${GREEN}✓ {{ tool_name }} deployed${NC}"
{% endfor %}

# Step 6: Publish Prompts to Azure AI Foundry
{% else %}
# Step 5: Publish Prompts to Azure AI Foundry
{% endif %}
echo -e "${BLUE}Step {% if tools %}6{% else %}5{% endif %}: Publishing prompts to AI Foundry${NC}"

# Set environment variables for publishing
export AI_FOUNDRY_PROJECT="{{ goal_id }}"
export PROMPT_VERSION="${IMAGE_TAG}"

# Run publish script
if command -v python3 &> /dev/null; then
    python3 scripts/publish_prompts.py
elif command -v python &> /dev/null; then
    python scripts/publish_prompts.py
else
    echo -e "${YELLOW}⚠ Python not found, skipping prompt publishing${NC}"
    echo -e "${YELLOW}  Prompts are available locally in prompts/ directory${NC}"
fi

echo -e "${GREEN}=== Deployment Complete ===${NC}"
echo ""
echo "Application is available at: https://$API_URL"
echo "Test with: curl https://$API_URL/health"
